<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Interaction Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #34495e;
      --success: #2ecc71;
      --warning: #f39c12;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary), var(--dark));
      color: white;
      padding: 20px 0;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo i {
      font-size: 2.5rem;
      color: var(--secondary);
    }
    
    .logo h1 {
      font-size: 2.2rem;
      font-weight: 700;
    }
    
    .logo span {
      color: var(--secondary);
    }
    
    .directory-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }
    
    .directory-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .directory-header i {
      color: var(--secondary);
      font-size: 1.5rem;
    }
    
    .directory-input {
      display: flex;
      gap: 10px;
    }
    
    .directory-input input {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .directory-input input:focus {
      border-color: var(--secondary);
      outline: none;
    }
    
    .directory-input button {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .directory-input button:hover {
      background: #2980b9;
    }
    
    .main-content {
      display: flex;
      gap: 30px;
      margin-bottom: 30px;
    }
    
    .customer-list {
      flex: 1;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .customer-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .customer-list-header h2 {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .customer-list-header h2 i {
      color: var(--secondary);
    }
    
    .add-customer-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
    }
    
    .customer-search {
      margin-bottom: 20px;
      position: relative;
    }
    
    .customer-search input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .customer-search i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }
    
    .customer-dropdown {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 20px;
      background: white;
      cursor: pointer;
    }
    
    .customer-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }
    
    .customer-card {
      background: white;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .customer-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      border-color: var(--secondary);
    }
    
    .customer-card.active {
      border-color: var(--secondary);
      background-color: #f0f8ff;
    }
    
    .customer-card h3 {
      color: var(--primary);
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .customer-card p {
      color: #777;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    
    .customer-card .meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #999;
    }
    
    .customer-profile {
      flex: 2;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      padding: 25px;
      display: flex;
      flex-direction: column;
    }
    
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 25px;
      border-bottom: 2px solid #eee;
      padding-bottom: 20px;
    }
    
    .customer-info h2 {
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .customer-contact {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    
    .contact-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #555;
    }
    
    .last-interaction {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #666;
    }
    
    .profile-tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      color: #777;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab.active {
      color: var(--secondary);
      border-bottom: 3px solid var(--secondary);
    }
    
    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px 5px;
    }
    
    .notes-section {
      display: none;
    }
    
    .notes-section.active {
      display: block;
    }
    
    .note-form {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    
    .note-form textarea {
      width: 100%;
      height: 100px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      resize: vertical;
      font-size: 1rem;
      margin-bottom: 15px;
    }
    
    .note-form textarea:focus {
      border-color: var(--secondary);
      outline: none;
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .form-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .submit-btn {
      background: var(--success);
      color: white;
    }
    
    .upload-btn {
      background: var(--secondary);
      color: white;
    }
    
    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .note-item {
      background: white;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
    }
    
    .note-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .note-date {
      color: #777;
      font-size: 0.9rem;
    }
    
    .note-author {
      font-weight: 600;
      color: var(--dark);
    }
    
    .note-content {
      line-height: 1.6;
      color: #555;
    }
    
    .files-section {
      display: none;
    }
    
    .files-section.active {
      display: block;
    }
    
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }
    
    .file-item {
      background: #f9f9f9;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #eee;
      transition: transform 0.3s;
    }
    
    .file-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    
    .file-preview {
      height: 120px;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: #6c757d;
    }
    
    .file-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .file-info {
      padding: 12px;
    }
    
    .file-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 5px;
    }
    
    .file-meta {
      display: flex;
      justify-content: space-between;
      color: #777;
      font-size: 0.85rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #777;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #ddd;
    }
    
    .empty-state h3 {
      margin-bottom: 10px;
      color: #555;
    }
    
    .add-customer-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .add-customer-modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: white;
      width: 500px;
      max-width: 90%;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    
    .add-customer-modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #777;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      border-color: var(--secondary);
      outline: none;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .current-directory {
      background: #e3f2fd;
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }
    
    .current-directory i {
      color: var(--secondary);
    }
    
    .file-upload {
      position: relative;
      margin-bottom: 15px;
    }
    
    .file-upload input {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }
    
    .file-upload-label {
      display: block;
      padding: 12px;
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .file-upload-label:hover {
      background: #e9ecef;
      border-color: var(--secondary);
    }
    
    .file-upload-label i {
      margin-right: 8px;
      color: var(--secondary);
    }
    
    .upload-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .upload-item {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      background: #e9ecef;
    }
    
    .upload-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .upload-item .remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      background: var(--success);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.error {
      background: var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <div class="logo">
          <i class="fas fa-users"></i>
          <h1>Customer <span>Hub</span></h1>
        </div>
      </div>
    </header>
    
    <div class="directory-section">
      <div class="directory-header">
        <i class="fas fa-folder-open"></i>
        <h2>Data Directory</h2>
      </div>
      <div class="directory-input">
        <input type="text" id="directory-path" placeholder="Select a directory to save customer data" readonly>
        <button id="select-dir-btn">
          <i class="fas fa-folder"></i> Select Directory
        </button>
      </div>
      <div id="current-dir" class="current-directory" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span>Data will be saved in: <span id="current-dir-path"></span></span>
      </div>
    </div>
    
    <div class="main-content">
      <div class="customer-list">
        <div class="customer-list-header">
          <h2><i class="fas fa-user-friends"></i> Customers</h2>
          <button class="add-customer-btn" id="add-customer-btn">
            <i class="fas fa-plus"></i> Add Customer
          </button>
        </div>
        
        <div class="customer-search">
          <i class="fas fa-search"></i>
          <input type="text" id="customer-search" placeholder="Search customers...">
        </div>
        
        <select class="customer-dropdown" id="customer-dropdown">
          <option value="">Select a customer...</option>
        </select>
        
        <div class="customer-cards" id="customer-cards">
          <!-- Customer cards will be populated here -->
        </div>
      </div>
      
      <div class="customer-profile" id="customer-profile">
        <div class="profile-header">
          <div class="customer-info">
            <h2 id="customer-name"><i class="fas fa-user"></i> Select a customer</h2>
            <div id="customer-contact" class="customer-contact" style="display: none;">
              <div class="contact-item">
                <i class="fas fa-phone"></i>
                <span id="customer-phone">(123) 456-7890</span>
              </div>
              <div class="contact-item">
                <i class="fas fa-envelope"></i>
                <span id="customer-email">customer@example.com</span>
              </div>
            </div>
          </div>
          <div id="last-interaction" class="last-interaction" style="display: none;">
            <strong>Last interaction:</strong> <span id="last-interaction-date">Today</span>
          </div>
        </div>
        
        <div class="profile-tabs">
          <div class="tab active" data-tab="notes">Notes</div>
          <div class="tab" data-tab="files">Files & Photos</div>
        </div>
        
        <div class="tab-content">
          <div class="notes-section active" id="notes-section">
            <div class="note-form">
              <textarea id="note-content" placeholder="Add a note about this customer..."></textarea>
              <div class="file-upload">
                <div class="file-upload-label">
                  <i class="fas fa-paperclip"></i> Attach Files or Photos
                  <input type="file" id="file-input" multiple>
                </div>
              </div>
              <div class="upload-preview" id="upload-preview"></div>
              <div class="form-actions">
                <button class="upload-btn" id="upload-btn">
                  <i class="fas fa-upload"></i> Upload Files
                </button>
                <button class="submit-btn" id="save-note-btn">
                  <i class="fas fa-save"></i> Save Note
                </button>
              </div>
            </div>
            
            <div class="notes-list" id="notes-list">
              <div class="empty-state">
                <i class="fas fa-sticky-note"></i>
                <h3>No notes yet</h3>
                <p>Add your first note to get started</p>
              </div>
            </div>
          </div>
          
          <div class="files-section" id="files-section">
            <div class="file-grid" id="file-grid">
              <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <h3>No files uploaded</h3>
                <p>Upload files or photos for this customer</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="add-customer-modal" id="add-customer-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Customer</h3>
        <button class="close-modal" id="close-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="form-group">
        <label for="new-customer-name">Full Name</label>
        <input type="text" id="new-customer-name" placeholder="John Doe">
      </div>
      <div class="form-group">
        <label for="new-customer-email">Email</label>
        <input type="email" id="new-customer-email" placeholder="john@example.com">
      </div>
      <div class="form-group">
        <label for="new-customer-phone">Phone</label>
        <input type="text" id="new-customer-phone" placeholder="(123) 456-7890">
      </div>
      <div class="form-group">
        <label for="new-customer-company">Company</label>
        <input type="text" id="new-customer-company" placeholder="Company Name">
      </div>
      <div class="modal-footer">
        <button class="upload-btn" id="cancel-customer">
          Cancel
        </button>
        <button class="submit-btn" id="save-customer">
          Save Customer
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    // Renderer process JavaScript
    document.addEventListener('DOMContentLoaded', async () => {
      // Elements
      const dirPathInput = document.getElementById('directory-path')
      const selectDirBtn = document.getElementById('select-dir-btn')
      const currentDirEl = document.getElementById('current-dir')
      const currentDirPath = document.getElementById('current-dir-path')
      const customerDropdown = document.getElementById('customer-dropdown')
      const customerCards = document.getElementById('customer-cards')
      const customerProfile = document.getElementById('customer-profile')
      const customerName = document.getElementById('customer-name')
      const customerContact = document.getElementById('customer-contact')
      const customerPhone = document.getElementById('customer-phone')
      const customerEmail = document.getElementById('customer-email')
      const lastInteraction = document.getElementById('last-interaction')
      const lastInteractionDate = document.getElementById('last-interaction-date')
      const tabs = document.querySelectorAll('.tab')
      const noteSection = document.getElementById('notes-section')
      const filesSection = document.getElementById('files-section')
      const noteContent = document.getElementById('note-content')
      const fileInput = document.getElementById('file-input')
      const uploadPreview = document.getElementById('upload-preview')
      const saveNoteBtn = document.getElementById('save-note-btn')
      const uploadBtn = document.getElementById('upload-btn')
      const notesList = document.getElementById('notes-list')
      const fileGrid = document.getElementById('file-grid')
      const addCustomerBtn = document.getElementById('add-customer-btn')
      const addCustomerModal = document.getElementById('add-customer-modal')
      const closeModal = document.getElementById('close-modal')
      const cancelCustomer = document.getElementById('cancel-customer')
      const saveCustomer = document.getElementById('save-customer')
      const newCustomerName = document.getElementById('new-customer-name')
      const newCustomerEmail = document.getElementById('new-customer-email')
      const newCustomerPhone = document.getElementById('new-customer-phone')
      const newCustomerCompany = document.getElementById('new-customer-company')
      const toast = document.getElementById('toast')
      const customerSearch = document.getElementById('customer-search')
      
      // State
      let currentCustomer = null
      let selectedFiles = []
      let customers = []
      
      // Initialize
      checkDataDirectory()
      loadCustomers()
      
      // Event Listeners
      selectDirBtn.addEventListener('click', async () => {
        const dirPath = await window.electronAPI.selectDirectory()
        if (dirPath) {
          dirPathInput.value = dirPath
          currentDirPath.textContent = dirPath
          currentDirEl.style.display = 'flex'
          showToast('Data directory set successfully!')
          loadCustomers()
        }
      })
      
      customerDropdown.addEventListener('change', (e) => {
        const customerId = e.target.value
        if (customerId) {
          const customer = customers.find(c => c.id === customerId)
          if (customer) {
            selectCustomer(customer)
          }
        }
      })
      
      customerSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase()
        filterCustomers(searchTerm)
      })
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'))
          tab.classList.add('active')
          
          noteSection.classList.remove('active')
          filesSection.classList.remove('active')
          
          if (tab.dataset.tab === 'notes') {
            noteSection.classList.add('active')
          } else if (tab.dataset.tab === 'files') {
            filesSection.classList.add('active')
          }
        })
      })
      
      fileInput.addEventListener('change', (e) => {
        selectedFiles = Array.from(e.target.files)
        renderFilePreviews()
      })
      
      saveNoteBtn.addEventListener('click', saveNote)
      uploadBtn.addEventListener('click', uploadFiles)
      
      addCustomerBtn.addEventListener('click', () => {
        addCustomerModal.classList.add('active')
      })
      
      closeModal.addEventListener('click', closeCustomerModal)
      cancelCustomer.addEventListener('click', closeCustomerModal)
      
      saveCustomer.addEventListener('click', async () => {
        if (!newCustomerName.value.trim()) {
          showToast('Customer name is required', true)
          return
        }
        
        const newCustomer = {
          id: Date.now().toString(),
          name: newCustomerName.value.trim(),
          email: newCustomerEmail.value.trim(),
          phone: newCustomerPhone.value.trim(),
          company: newCustomerCompany.value.trim(),
          interactions: []
        }
        
        const success = await window.electronAPI.saveCustomer(newCustomer)
        if (success) {
          showToast('Customer added successfully!')
          closeCustomerModal()
          loadCustomers()
          selectCustomer(newCustomer)
        } else {
          showToast('Error saving customer', true)
        }
      })
      
      // Functions
      async function checkDataDirectory() {
        const dataDir = await window.electronAPI.getDataDirectory()
        if (dataDir) {
          dirPathInput.value = dataDir
          currentDirPath.textContent = dataDir
          currentDirEl.style.display = 'flex'
        }
      }
      
      async function loadCustomers() {
        customers = await window.electronAPI.getCustomers()
        renderCustomerDropdown()
        renderCustomerCards()
      }
      
      function renderCustomerDropdown() {
        customerDropdown.innerHTML = '<option value="">Select a customer...</option>'
        customers.forEach(customer => {
          const option = document.createElement('option')
          option.value = customer.id
          option.textContent = customer.name
          customerDropdown.appendChild(option)
        })
      }
      
      function renderCustomerCards() {
        customerCards.innerHTML = ''
        
        if (customers.length === 0) {
          customerCards.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-user-friends"></i>
              <h3>No customers yet</h3>
              <p>Add your first customer to get started</p>
            </div>
          `
          return
        }
        
        customers.forEach(customer => {
          const card = document.createElement('div')
          card.className = 'customer-card'
          if (currentCustomer && currentCustomer.id === customer.id) {
            card.classList.add('active')
          }
          
          const interactionCount = customer.interactions ? customer.interactions.length : 0
          const lastInteraction = customer.interactions && customer.interactions.length > 0 
            ? new Date(customer.interactions[customer.interactions.length - 1].timestamp).toLocaleDateString()
            : 'No interactions'
          
          card.innerHTML = `
            <h3><i class="fas fa-user"></i> ${customer.name}</h3>
            <p>${customer.company || 'No company'}</p>
            <div class="meta">
              <span>${interactionCount} interactions</span>
              <span>Last: ${lastInteraction}</span>
            </div>
          `
          
          card.addEventListener('click', () => {
            selectCustomer(customer)
          })
          
          customerCards.appendChild(card)
        })
      }
      
      function filterCustomers(searchTerm) {
        if (!searchTerm) {
          renderCustomerCards()
          return
        }
        
        const filtered = customers.filter(customer => 
          customer.name.toLowerCase().includes(searchTerm) ||
          (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
          (customer.phone && customer.phone.toLowerCase().includes(searchTerm)) ||
          (customer.company && customer.company.toLowerCase().includes(searchTerm))
        
        customerCards.innerHTML = ''
        
        if (filtered.length === 0) {
          customerCards.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-search"></i>
              <h3>No matching customers</h3>
              <p>Try a different search term</p>
            </div>
          `
          return
        }
        
        filtered.forEach(customer => {
          const card = document.createElement('div')
          card.className = 'customer-card'
          if (currentCustomer && currentCustomer.id === customer.id) {
            card.classList.add('active')
          }
          
          const interactionCount = customer.interactions ? customer.interactions.length : 0
          const lastInteraction = customer.interactions && customer.interactions.length > 0 
            ? new Date(customer.interactions[customer.interactions.length - 1].timestamp).toLocaleDateString()
            : 'No interactions'
          
          card.innerHTML = `
            <h3><i class="fas fa-user"></i> ${customer.name}</h3>
            <p>${customer.company || 'No company'}</p>
            <div class="meta">
              <span>${interactionCount} interactions</span>
              <span>Last: ${lastInteraction}</span>
            </div>
          `
          
          card.addEventListener('click', () => {
            selectCustomer(customer)
          })
          
          customerCards.appendChild(card)
        })
      }
      
      function selectCustomer(customer) {
        currentCustomer = customer
        customerName.innerHTML = `<i class="fas fa-user"></i> ${customer.name}`
        customerPhone.textContent = customer.phone || 'No phone'
        customerEmail.textContent = customer.email || 'No email'
        customerContact.style.display = 'flex'
        
        if (customer.interactions && customer.interactions.length > 0) {
          const lastInteraction = customer.interactions[customer.interactions.length - 1]
          lastInteractionDate.textContent = new Date(lastInteraction.timestamp).toLocaleString()
          lastInteraction.style.display = 'block'
        } else {
          lastInteraction.style.display = 'none'
        }
        
        // Update dropdown
        customerDropdown.value = customer.id
        
        // Update cards
        document.querySelectorAll('.customer-card').forEach(card => {
          card.classList.remove('active')
        })
        
        const activeCard = Array.from(document.querySelectorAll('.customer-card')).find(card => {
          return card.querySelector('h3').textContent.includes(customer.name)
        })
        
        if (activeCard) {
          activeCard.classList.add('active')
        }
        
        // Load notes and files
        loadNotes()
        loadFiles()
      }
      
      function renderFilePreviews() {
        uploadPreview.innerHTML = ''
        
        if (selectedFiles.length === 0) {
          return
        }
        
        selectedFiles.forEach((file, index) => {
          const reader = new FileReader()
          
          reader.onload = (e) => {
            const preview = document.createElement('div')
            preview.className = 'upload-item'
            
            if (file.type.startsWith('image/')) {
              preview.innerHTML = `
                <img src="${e.target.result}" alt="${file.name}">
                <button class="remove" data-index="${index}">
                  <i class="fas fa-times"></i>
                </button>
              `
            } else {
              preview.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                  <i class="fas fa-file" style="font-size: 2rem;"></i>
                </div>
                <button class="remove" data-index="${index}">
                  <i class="fas fa-times"></i>
                </button>
              `
            }
            
            uploadPreview.appendChild(preview)
            
            // Add remove event
            preview.querySelector('.remove').addEventListener('click', (e) => {
              e.stopPropagation()
              const idx = parseInt(e.target.closest('.remove').dataset.index)
              selectedFiles.splice(idx, 1)
              renderFilePreviews()
            })
          }
          
          reader.readAsDataURL(file)
        })
      }
      
      async function saveNote() {
        if (!currentCustomer) {
          showToast('Please select a customer first', true)
          return
        }
        
        const noteText = noteContent.value.trim()
        if (!noteText && selectedFiles.length === 0) {
          showToast('Note or file is required', true)
          return
        }
        
        // Upload files first if any
        let fileNames = []
        if (selectedFiles.length > 0) {
          fileNames = await uploadFiles()
        }
        
        // Save the note
        const interaction = {
          customerId: currentCustomer.id,
          type: 'note',
          content: noteText,
          files: fileNames
        }
        
        const success = await window.electronAPI.saveInteraction(interaction)
        if (success) {
          showToast('Note saved successfully!')
          noteContent.value = ''
          selectedFiles = []
          uploadPreview.innerHTML = ''
          loadNotes()
        } else {
          showToast('Error saving note', true)
        }
      }
      
      async function uploadFiles() {
        if (!currentCustomer) {
          showToast('Please select a customer first', true)
          return []
        }
        
        if (selectedFiles.length === 0) {
          showToast('No files selected', true)
          return []
        }
        
        const fileNames = []
        
        for (const file of selectedFiles) {
          const arrayBuffer = await file.arrayBuffer()
          const fileName = await window.electronAPI.saveFile({
            name: file.name,
            data: new Uint8Array(arrayBuffer)
          })
          
          if (fileName) {
            fileNames.push(fileName)
          }
        }
        
        if (fileNames.length > 0) {
          showToast(`${fileNames.length} file(s) uploaded successfully!`)
          selectedFiles = []
          uploadPreview.innerHTML = ''
          loadFiles()
          return fileNames
        } else {
          showToast('Error uploading files', true)
          return []
        }
      }
      
      function loadNotes() {
        if (!currentCustomer || !currentCustomer.interactions) {
          notesList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-sticky-note"></i>
              <h3>No notes yet</h3>
              <p>Add your first note to get started</p>
            </div>
          `
          return
        }
        
        const notes = currentCustomer.interactions
          .filter(i => i.type === 'note')
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        
        if (notes.length === 0) {
          notesList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-sticky-note"></i>
              <h3>No notes yet</h3>
              <p>Add your first note to get started</p>
            </div>
          `
          return
        }
        
        notesList.innerHTML = ''
        
        notes.forEach(note => {
          const noteDate = new Date(note.timestamp)
          const formattedDate = noteDate.toLocaleString()
          
          const noteEl = document.createElement('div')
          noteEl.className = 'note-item'
          noteEl.innerHTML = `
            <div class="note-header">
              <div class="note-author">You</div>
              <div class="note-date">${formattedDate}</div>
            </div>
            <div class="note-content">
              ${note.content}
            </div>
          `
          
          notesList.appendChild(noteEl)
        })
      }
      
      function loadFiles() {
        if (!currentCustomer || !currentCustomer.interactions) {
          fileGrid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-folder-open"></i>
              <h3>No files uploaded</h3>
              <p>Upload files or photos for this customer</p>
            </div>
          `
          return
        }
        
        // Collect all files from all interactions
        const allFiles = []
        currentCustomer.interactions.forEach(interaction => {
          if (interaction.files && interaction.files.length > 0) {
            interaction.files.forEach(file => {
              allFiles.push({
                name: file,
                timestamp: interaction.timestamp
              })
            })
          }
        })
        
        if (allFiles.length === 0) {
          fileGrid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-folder-open"></i>
              <h3>No files uploaded</h3>
              <p>Upload files or photos for this customer</p>
            </div>
          `
          return
        }
        
        fileGrid.innerHTML = ''
        
        allFiles.forEach(file => {
          const fileDate = new Date(file.timestamp)
          const formattedDate = fileDate.toLocaleDateString()
          const fileExt = file.name.split('.').pop().toLowerCase()
          const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt)
          
          const fileEl = document.createElement('div')
          fileEl.className = 'file-item'
          fileEl.innerHTML = `
            <div class="file-preview">
              ${isImage ? 
                `<img src="file://${await window.electronAPI.getDataDirectory()}/files/${file.name}" alt="${file.name}">` : 
                `<i class="fas fa-file"></i>`
              }
            </div>
            <div class="file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-meta">
                <span>${formattedDate}</span>
                <span>${fileExt.toUpperCase()}</span>
              </div>
            </div>
          `
          
          fileGrid.appendChild(fileEl)
        })
      }
      
      function closeCustomerModal() {
        addCustomerModal.classList.remove('active')
        newCustomerName.value = ''
        newCustomerEmail.value = ''
        newCustomerPhone.value = ''
        newCustomerCompany.value = ''
      }
      
      function showToast(message, isError = false) {
        toast.textContent = message
        toast.className = isError ? 'toast error' : 'toast'
        toast.classList.add('show')
        
        setTimeout(() => {
          toast.classList.remove('show')
        }, 3000)
      }
    })
  </script>
</body>
</html>